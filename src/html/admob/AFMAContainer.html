<script>
    (function() {
        var touches = [];

        window.addEventListener('pageshow', function() {
            AFMA_ReceiveMessage('onshow');
        });

        var startTouch;
        var endTouch;
        var touchStartTime;
        var upCounts = 0;
        var downCounts = 0;
        var moveCounts = 0;
        var cancelCounts = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            startTouch = e.touches[0];
            downCounts++;
        });
        document.addEventListener('touchend', function(e) {
            var duration = Date.now() - touchStartTime;
            endTouch = e.changedTouches[0];
            upCounts++;
        });
        document.addEventListener('touchmove', function(e) {
            moveCounts++;
        });
        document.addEventListener('touchcancel', function(e) {
            cancelCounts++;
        });

        window.addEventListener('message', function(e) {
            if (e.data.type === 'afma') {
                if (e.data.event === 'back') {
                    console.log('calling AFMA back function', e);
                    AFMA_ReceiveMessage('onbackblocked');
                }
            }
        });

        var AFMA = function() {
            var self = this;
            this.intentCallbacks = {};
            this.intentCallbackId = 0;

            this.sentQuartiles = {};

            document.addEventListener('DOMContentLoaded', function() {
                var videoEl = document.querySelector('video');
                if (videoEl === null) {
                    // TODO, warn?
                    return;
                }

                videoEl.addEventListener('error', function() {
                    var error = videoEl.error;
                    self.postMessage('tracking', {
                        event: 'error',
                        data: JSON.stringify(error)
                    });
                });

                videoEl.addEventListener('timeupdate', function() {
                    var quartile = Math.floor((videoEl.currentTime / videoEl.duration) * 4);
                    if (quartile !== 0 && !(quartile in self.sentQuartiles)) {
                        self.sentQuartiles[quartile] = true;
                        var adQuartile;
                        switch (quartile) {
                            case 1:
                                adQuartile = 'firstQuartile';
                                break;
                            case 2:
                                adQuartile = 'secondQuartile';
                                break;
                            case 3:
                                adQuartile = 'thirdQuartile';
                                break;
                        }
                        if (adQuartile) {
                            self.postMessage('tracking', {
                                event: adQuartile
                            });
                        }
                    }
                });

                videoEl.addEventListener('stalled', function() {
                    self.postMessage('tracking', {
                        event: 'stalled'
                    });
                });

                videoEl.addEventListener('canplay', function() {
                    self.postMessage('tracking', {
                        event: 'loaded'
                    });
                });
            });

            this.forceOrientation = function(orientation, override, animationDuration) {
                this.postMessage('forceOrientation', {
                    orientation: orientation,
                    override: override,
                    animationDuration: animationDuration
                });
            };

            this.click = function(url) {
                this.postMessage('click', {
                    url: url,
                    touch: {
                        start: {
                            x: startTouch ? startTouch.clientX : 0,
                            y: startTouch ? startTouch.clientY : 0
                        },
                        end: {
                            x: endTouch ? endTouch.clientX : 0,
                            y: endTouch ? endTouch.clientY : 0,
                        },
                        diameter: endTouch ? endTouch.radiusX * 2 : 0.0,
                        pressure: endTouch ? endTouch.force || 0.0 : 0.0,
                        counts: {
                            up: upCounts,
                            down: downCounts,
                            move: moveCounts,
                            cancel: cancelCounts
                        }
                    }
                });
            };

            this.getClickSignals = function(clickString) {
                return null;
            };

            this.appendClickSignals = function(url, spamSignals) {
                return url;
            };

            this.notifyRewardedVideoStart = function() {
                this.postMessage('rewardedVideoStart');
            };

            this.grantReward = function() {
                this.postMessage('grantReward');
            };

            this.close = function(notifyParent) {
                this.postMessage('close');
            };

            this.disableBackButton = function(disabled) {
                this.postMessage('disableBackButton', {
                    disabled: disabled
                });
            };

            this.openIntent = function(url, action, mimeType) {
                this.postMessage('openIntent', {
                    url: url,
                    action: action,
                    mimeType: mimeType
                });
                return false;
            };

            this.openIntentExtended = function(params) {
                return this.openIntent(params.url, params.action, params.mimeType);
            };

            this.openUrl = function(url) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openDeepLinkUrl = function(url, callback, failIfUnsure, packageName) {
                this.postMessage('openUrl', {
                    url: url
                });
                callback();
            };

            this.openBrowser = function(url) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openNativeApp = function(url) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openSystemBrowser = function(url, options) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openStoreOverlay = function(url) {
                this.postMessage('openStoreOverlay', {
                    url: url
                });
            };

            this.openInAppStore = function(productId, url, waitForFetch) {
                this.postMessage('openInAppStore', {
                    productId: productId,
                    url: url
                });
            };

            this.fetchAppStoreOverlay = function(productId) {
                this.postMessage('fetchAppStoreOverlay', {
                    productId: productId
                });
            };

            this.canOpenUrls = function(urls, callback, timeoutCallback, timeoutMillis) {
                var canDo = {};
                if (urls.length) {
                    for (var i = 0; i < urls.length; i++) {
                        canDo[urls[i]] = true;
                    }
                } else {
                    canDo[urls] = true;
                }
                callback('openableURLs', canDo);
            };

            this.canOpenIntents = function(intents, callback, timeoutCallback, timeoutMillis) {
                var id = self.intentCallbackId++;
                self.intentCallbacks[id] = {
                    callback: callback,
                    timer: setTimeout(function() {
                        timeoutCallback();
                        delete self.intentCallbacks[id];
                    }, timeoutMillis)
                };
                this.postMessage('openableIntents', {
                    id: id,
                    intents: intents
                });
            };

            this.postMessage = function(event, data) {
                window.parent.postMessage({
                    type: 'afma',
                    event: event,
                    data: data
                }, '*');
            };

            this.handleOpenableIntentResponse = function(response) {
                var callbackId = response.id;
                var resolutions = response.results;
                if (callbackId in self.intentCallbacks) {
                    var callback = self.intentCallbacks[callbackId].callback;
                    callback('openableIntents', resolutions);
                    clearTimeout(self.intentCallbacks[callbackId].timer);
                    delete self.intentCallbacks[callbackId];
                }
            }

            // MRAID proxy functions
            this.setOrienationProperties = function(properties) {
                window.mraid.setOrienationProperties(properties);
            };

            this.useCustomClose = function(uses) {
            };

            window.addEventListener('message', function(e) {
                if (e.data.type === 'afma') {
                    if (e.data.event === 'back') {
                        console.log('calling AFMA back function', e);
                        AFMA_ReceiveMessage('onbackblocked');
                    } else if (e.data.event === 'openableIntentsResponse') {
                        self.handleOpenableIntentResponse(e.data.data);
                    }
                }
            });
        };

        window.unity = window.unity || {};
        window.unity.afma = new AFMA();
    })();
</script>
