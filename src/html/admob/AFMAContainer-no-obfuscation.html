
<script>
    function getQueryParams(url) {
        var a = document.createElement('a');
        a.href = url;
        var params = {};
        if (a.search) {
            var tuples = a.search.substring(1).split(/&/);
            for (var i = 0; i < tuples.length; i++) {
                var parts = tuples[i].split(/=/);
                var key = parts[0];
                var value = parts[1];
                if (params[key]) {
                    params[key].push(value);
                } else {
                    params[key] = [value];
                }
            }
        }
        return params;
    }
    function isObjectEmpty(obj) {
        for (var prop in obj) {
            if (obj.hasOwnProperty(prop)) {
                return false;
            }
        }
        return true;
    }

    (function() {
        var touches = [];

        window.addEventListener('pageshow', function() {
            AFMA_ReceiveMessage('onshow');
        });

        var startTouch;
        var endTouch;
        var touchStartTime;
        var upCounts = 0;
        var downCounts = 0;
        var moveCounts = 0;
        var cancelCounts = 0;
        var touchDuration;

        document.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            startTouch = e.touches[0];
            downCounts++;
        });
        document.addEventListener('touchend', function(e) {
            touchDuration = Date.now() - touchStartTime;
            endTouch = e.changedTouches[0];
            upCounts++;
        });
        document.addEventListener('touchmove', function(e) {
            moveCounts++;
        });
        document.addEventListener('touchcancel', function(e) {
            cancelCounts++;
        });

        var AFMA = function() {
            var self = this;
            this.intentCallbacks = {};
            this.intentCallbackId = 0;
            this.sentQuartiles = {};
            var clickSignalListeners = [];
            var supposedCurrentTime = 0;
            var userSeeked = false;
            var hasSentStart = false;

            document.addEventListener('DOMContentLoaded', function() {

                self.postMessage('tracking', {
                    event: 'impression'
                });

                var videoEl = document.querySelector('video');
                if (videoEl === null) {
                    var error = 'videoEl for admob is not found';
                    self.postMessage('tracking', {
                        event: 'error',
                        data: JSON.stringify(error)
                    });
                    return;
                }

                videoEl.addEventListener('error', function() {
                    var error = videoEl.error;
                    self.postMessage('tracking', {
                        event: 'error',
                        data: JSON.stringify(error)
                    });
                });

                videoEl.addEventListener('timeupdate', function() {
                    if (!videoEl.seeking) {
                        supposedCurrentTime = videoEl.currentTime;

                        var quartile = Math.floor((videoEl.currentTime / videoEl.duration) * 4);
                        if (quartile !== 0 && !(quartile in self.sentQuartiles)) {
                            self.sentQuartiles[quartile] = true;
                            var adQuartile;
                            switch (quartile) {
                                case 1:
                                    adQuartile = 'firstQuartile';
                                    break;
                                case 2:
                                    adQuartile = 'midpoint';
                                    break;
                                case 3:
                                    adQuartile = 'thirdQuartile';
                                    break;
                            }
                            if (adQuartile) {
                                self.postMessage('tracking', {
                                    event: adQuartile
                                });
                            }
                        }
                    }
                });

                videoEl.addEventListener('stalled', function() {
                    self.postMessage('tracking', {
                        event: 'stalled'
                    });
                });

                videoEl.addEventListener('canplay', function() {
                    self.postMessage('tracking', {
                        event: 'loaded'
                    });
                });
                
                videoEl.addEventListener('seeking', function() {
                    var delta = videoEl.currentTime - supposedCurrentTime;
                    if (Math.abs(delta) > 0.01) {
                        videoEl.currentTime = supposedCurrentTime;
                    }
                    if (!userSeeked) {
                        userSeeked = true;
                        self.postMessage('seeked');
                    }
                });

                videoEl.addEventListener('playing', function() {
                    if (!hasSentStart) {
                        hasSentStart = true;
                        self.postMessage('videoStart');
                    }
                });
            });

            this.forceOrientation = function(orientation, override, animationDuration) {
                this.postMessage('forceOrientation', {
                    orientation: orientation,
                    override: override,
                    animationDuration: animationDuration
                });
            };

            this.click = function(url) {
                var touchInfo = self.getTouchInfo();
                this.postMessage('click', {
                    url: url,
                    touch: touchInfo
                });
            };

            this.getClickSignals = function(cs) {
                return null;
            };

            this.appendClickSignals = function(url, ss) {
                return url;
            };

            this.getClickSignalsAsync = function(cs) {
                return new Promise(function(resolve, reject) {
                    self.requestClickSignal(resolve);
                });
            }

            this.appendClickSignalsAsync = function(url, ss) {
                var signalPromise = ss ? Promise.resolve(ss) : this.getClickSignalsAsync(url);
                return signalPromise.then(function(signalObject) {
                    var clickSignals = signalObject.encodedClickSignal;
                    var query = getQueryParams(url);
                    if (!query.ms) {
                        if (isObjectEmpty(query)) {
                            url = url + '?ms=' + clickSignals;
                        } else {
                            url = url + '&ms=' + clickSignals;
                        }
                    }
                    var rvdt = signalObject.rvdt;
                    url = url + '&rvdt=' + rvdt;
                    return url;
                });
            };

            this.requestClickSignal = function(resolve) {
                clickSignalListeners.push(resolve);
                var touchInfo = this.getTouchInfo();
                this.postMessage('getClickSignal', touchInfo);
            };
            this.getTouchInfo = function() {
                var touchInfo = {
                    counts: {
                        up: upCounts,
                        down: downCounts,
                        move: moveCounts,
                        cancel: cancelCounts
                    }
                };
                if (startTouch) {
                    touchInfo.start = {
                        x: startTouch.clientX || 0.0,
                        y: startTouch.clientY || 0.0
                    };
                }
                if (endTouch) {
                    touchInfo.end = {
                        x: endTouch.clientX || 0.0,
                        y: endTouch.clientY || 0.0,
                    };
                    touchInfo.diameter = endTouch.radiusX * 2,
                    touchInfo.pressure = endTouch.force || 0.0;
                }
                if (touchDuration) {
                    touchInfo.duration = touchDuration;
                }
                return touchInfo;
            };

            this.onReceiveClickSignal = function(signal) {
                for (var i = 0, len = clickSignalListeners.length; i < len; i++) {
                    clickSignalListeners[i](signal);
                }
                clickSignalListeners = [];
            };

            this.notifyRewardedVideoStart = function() {
                // Do nothing, but leave so Admob can continue calling it
            };

            this.grantReward = function() {
                this.postMessage('grantReward');
            };

            this.close = function(notifyParent) {
                this.postMessage('close');
            };

            this.disableBackButton = function(disabled) {
                this.postMessage('disableBackButton', {
                    disabled: disabled
                });
            };

            this.openIntent = function(url, action, mimeType) {
                this.postMessage('openIntent', {
                    url: url,
                    action: action,
                    mimeType: mimeType
                });
                return false;
            };

            this.openIntentExtended = function(params) {
                return this.openIntent(params.url, params.action, params.mimeType);
            };

            this.openUrl = function(url) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openDeepLinkUrl = function(url, callback, failIfUnsure, packageName) {
                this.postMessage('openUrl', {
                    url: url
                });
                callback();
            };

            this.openBrowser = function(url) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openNativeApp = function(url) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openSystemBrowser = function(url, options) {
                this.postMessage('openUrl', {
                    url: url
                });
            };

            this.openStoreOverlay = function(url) {
                this.postMessage('openStoreOverlay', {
                    url: url
                });
            };

            this.openInAppStore = function(productId, url, waitForFetch) {
                this.postMessage('openInAppStore', {
                    productId: productId,
                    url: url
                });
            };

            this.fetchAppStoreOverlay = function(productId) {
                this.postMessage('fetchAppStoreOverlay', {
                    productId: productId
                });
            };

            this.canOpenUrls = function(urls, callback, timeoutCallback, timeoutMillis) {
                var canDo = {};
                if (urls.length) {
                    for (var i = 0; i < urls.length; i++) {
                        canDo[urls[i]] = true;
                    }
                } else {
                    canDo[urls] = true;
                }
                callback('openableURLs', canDo);
            };

            this.canOpenIntents = function(intents, callback, timeoutCallback, timeoutMillis) {
                var id = self.intentCallbackId++;
                self.intentCallbacks[id] = {
                    callback: callback,
                    timer: setTimeout(function() {
                        timeoutCallback();
                        delete self.intentCallbacks[id];
                    }, timeoutMillis)
                };
                this.postMessage('openableIntents', {
                    id: id,
                    intents: intents
                });
            };

            this.postMessage = function(event, data) {
                window.parent.postMessage({
                    type: 'afma',
                    event: event,
                    data: data
                }, '*');
            };

            this.handleOpenableIntentResponse = function(response) {
                var callbackId = response.id;
                var resolutions = response.results;
                if (callbackId in self.intentCallbacks) {
                    var callback = self.intentCallbacks[callbackId].callback;
                    callback('openableIntents', resolutions);
                    clearTimeout(self.intentCallbacks[callbackId].timer);
                    delete self.intentCallbacks[callbackId];
                }
            }

            // MRAID proxy functions
            this.setOrienationProperties = function(properties) {
                window.mraid.setOrienationProperties(properties);
            };

            this.useCustomClose = function(uses) {
            };

            window.addEventListener('message', function(e) {
                if (e.data.type === 'afma') {
                    if (e.data.event === 'back') {
                        console.log('calling AFMA back function', e);
                        AFMA_ReceiveMessage('onbackblocked');
                    } else if (e.data.event === 'openableIntentsResponse') {
                        self.handleOpenableIntentResponse(e.data.data);
                    } else if (e.data.event === 'clickSignal') {
                        console.log('recieved click signal', e);
                        self.onReceiveClickSignal(e.data.data);
                    }
                }
            });
        };

        window.unity = window.unity || {};
        window.unity.afma = new AFMA();
    })();
</script>
