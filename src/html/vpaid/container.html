<html>
<head>
    <style>
        /* just a shadow iframe for loading the VPAID src */
        iframe {
            display: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .video-player-slot {
            width: 100%;
            height: 100%;
        }

        .video-player-slot video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="video-player-slot">
        <video
            poster="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzUiIGhlaWd
            odD0iMTAwIiB2aWV3Qm94PSIwIDAgMjc1IDEwMCI+CiAgPHBhdGggZD0iTTgyLjc3NSA3OS44ND
            JMNjQuOSA0OS43NzVsMTcuODc1LTMwLjA2NyA4LjYxNyAzMC4wNjctOC42MTcgMzAuMDY3em0tM
            zkuNzgzLTIuOTM0TDIwLjUzMyA1NC42MzNoMzUuNzVMNzQuMTU4IDg0LjdsLTMxLjE2Ni03Ljc5
            MnptMC01NC4zNThsMzEuMDc1LTcuNzkyLTE3Ljg3NSAzMC4wNjdoLTM1Ljc1bDIyLjU1LTIyLjI
            3NXpNODguNjQyIDBMNDguMDMzIDEwLjU0MiA0MS45ODMgMjAuOWwtMTIuMTkxLS4wOTJMMCA0OS
            43NzVsMjkuNzkyIDI4Ljk2NyAxMi4xOTEtLjA5MiA2LjA1IDEwLjM1OCA0MC42MDkgMTAuNjM0T
            Dk5LjU1IDYwLjEzM2wtNi4xNDItMTAuMjY2TDk5LjU1IDM5LjYgODguNjQyIDB6bTkyLjIxNiAy
            OS4yNDJjLTUuNDA4IDAtOS4wNzUgMi4yOTEtMTEuODI1IDYuNTA4aC0uMTgzdi01LjQwOGgtOS4
            1MzN2MzkuNzgzaDkuNzE2di0yMi41NWMwLTUuNDA4IDMuMzkyLTkuMTY3IDguMDY3LTkuMTY3ID
            QuNCAwIDcuNyAyLjY1OSA3LjcgNy4zMzR2MjQuNDc1aDkuNzE3VjQ0LjE4M2MuMDkxLTguNzA4L
            TUuNDA5LTE0Ljk0MS0xMy42NTktMTQuOTQxem0tMzYuMyAyNC4xMDhjMCA1LjMxNy0zLjAyNSA4
            Ljk4My03Ljk3NSA4Ljk4My00LjQ5MSAwLTcuMzMzLTIuNTY2LTcuMzMzLTcuMjQxdi0yNC43NWg
            tOS43MTd2MjYuNTgzYzAgOC43MDggNC45NSAxNC4zOTIgMTMuODQyIDE0LjM5MiA1LjU5MiAwID
            guNzA4LTIuMTA5IDExLjM2Ny01Ljc3NWguMjc1djQuNjc1aDkuMzVWMzAuMzQyaC05LjcxN1Y1M
            y4zNWgtLjA5MnptNTUuMTg0LTIzLjAwOGg5LjcxNnYzOS43ODNoLTkuNzE2VjMwLjM0MnptMC0x
            Mi4zNzVoOS43MTZ2Ny45NzVoLTkuNzE2di03Ljk3NXptNjQuODA4IDEyLjM3NWwtNS43NzUgMTc
            uOTY2Yy0xLjI4MyAzLjY2Ny0yLjI5MiA4LjcwOS0yLjI5MiA4LjcwOWgtLjI3NXMtMS4yODMtNS
            4wNDItMi41NjYtOC43MDlsLTYuNTA5LTE3Ljk2NmgtMTAuNDVsMTAuNzI1IDI4LjMyNWMyLjI5M
            iA2LjA1IDMuMDI1IDguNjE2IDMuMDI1IDEwLjgxNiAwIDMuMy0xLjc0MSA1LjQwOS01Ljg2NiA1
            LjQwOWgtMy43NTl2OC4zNDFoNi4yMzRjOC4wNjYgMCAxMC45MDgtMy4yMDggMTMuOTMzLTEyLjA
            wOEwyNzUgMzAuNDMzaC0xMC40NXYtLjA5MXptLTM2Ljk0MiAyOC4xNDFWMzcuNGg2LjIzNHYtNi
            45NjdoLTYuMjM0VjE3Ljk2N2gtOS43MTZ2MTIuMzc1aC01LjV2Ni45NjZoNS41djIzLjM3NWMwI
            DcuNTE3IDUuNjgzIDkuNTM0IDEwLjgxNiA5LjUzNCA0LjIxNyAwIDUuMzE3LS4xODQgNS4zMTct
            LjE4NHYtNy43aC0yLjQ3NWMtMi4yOTIuMDkyLTMuOTQyLS45MTYtMy45NDItMy44NXoiIGZpbGw
            tcnVsZT0ibm9uemVybyIgZmlsbD0iI0ZGRiIvPgo8L3N2Zz4="
            playsinline>
        </video>
    </div>
    <iframe></iframe>
    <script>
        (function() {
            // List of all ad events
            var creativeEvents = [
                'loaded', 'skipped', 'started', 'stopped',
                'linearChange', 'expandedChange', 'remaningTimeChange',
                'volumeChange', 'impression', 'videoStart', 'videoFirstQuartile',
                'videoMidpoint', 'videoThirdQuartile', 'videoComplete',
                'clickThru', 'interaction', 'userAcceptInvitation',
                'userMinimize', 'userClose', 'paused', 'playing',
                'log', 'error'
            ];

            // VPAID_SRC_URL will be replaced by the WebView programmatically.
            function getIFrameDocumentContent() {
                return '<scr' + 'ipt src="{{VPAID_SRC_URL}}"></scr' + 'ipt>';
            }

            var Container = function() {
                this._iframe = document.querySelector('iframe');
                this._creative = null;
                this._slot = document.querySelector('.video-player-slot');
                this._videoSlot = this._slot.querySelector('video');

                var self = this;
                window.addEventListener('message', function(e) {
                    self._onMessage(e);
                });
            };

            Container.prototype.init = function() {
                var self = this;
                this._iframe.addEventListener('load', function() { self._onIFrameReady(); });
                this._iframe.contentDocument.write(getIFrameDocumentContent());
                this._iframe.contentDocument.close();
            };

            Container.prototype.getHandshakeVersion = function() {
                return this._creative.handshakeVersion('2.0');
            };

            Container.prototype.getAdDuration = function() {
                if (this._creative.getAdDuration) {
                    return this._creative.getAdDuration();
                } else {
                    return this._creative.adDuration || -2;
                }
            };

            Container.prototype.getAdRemainingTime = function() {
                if (this._creative.getAdRemainingTime) {
                    return this._creative.getAdRemainingTime();
            } else {
                    return this._creative.adRemainingTime || -2;
                }
            };

            Container.prototype._onIFrameReady = function() {
                var getVPAID = this._getVPAIDFunction();
                if (getVPAID && typeof getVPAID === 'function') {
                    this._creative = getVPAID();

                    this._subscribeToAllEvents();

                    window.parent.postMessage({
                        type: 'ready'
                    }, '*');
                } else {
                    this._triggerError('getVPAIDAd is not defined');
                }
            }

            Container.prototype._triggerError = function(e) {
                window.parent.postMessage({
                    type: 'VPAID',
                    eventType: 'AdError',
                    args: [e]
                }, '*');
            }

            Container.prototype._subscribeToAllEvents = function() {
                var len = creativeEvents.length;
                for (var i = 0; i < creativeEvents.length; i++) {
                    var creativeEvent = creativeEvents[i];
                    var normalizedEventName = 'Ad' + creativeEvent.charAt(0).toUpperCase() + creativeEvent.substring(1);
                    this._subscribeToEvent(normalizedEventName);
                }
            };

            Container.prototype._subscribeToEvent = function(eventName) {
                this._creative.subscribe(function() {
                    var args = [eventName].concat(Array.prototype.slice.call(arguments));
                    this._handleEvent.apply(this, args);
                }, eventName, this);
            }

            Container.prototype._getVPAIDFunction = function() {
                return this._iframe.contentWindow['getVPAIDAd'];
            };

            Container.prototype._handleEvent = function() {
                var eventType = arguments[0];
                var args = arguments.length > 1 ? Array.prototype.slice.call(arguments, 1) : [];

                window.parent.postMessage({
                    type: 'VPAID',
                    eventType: eventType,
                    args: args
                }, '*');
            };

            Container.prototype._initAd = function(width, height, viewMode, bitrate, creativeData, envVars) {
                this._version = this._creative.handshakeVersion('2.0');
                this._creative.initAd(width, height, viewMode, bitrate, creativeData, envVars);
            }

            Container.prototype._showAd = function() {
                this._creative.startAd();
            };

            Container.prototype._stopAd = function() {
                return this._creative.stopAd();
            };

            Container.prototype._onMessage = function(e) {
                switch (e.data.type) {
                    case 'init':
                        this._initAd(e.data.width, e.data.height, e.data.viewMode, e.data.bitrate, e.data.creativeData, {
                            slot: this._slot,
                            videoSlot: this._videoSlot
                        });
                        break;
                    case 'show':
                        this._showAd();
                        break;
                    case 'destroy':
                        this._stopAd();
                        break;
                    default:
                        // todo post back error
                        break;
                }
            }

            var container = window.container = new Container();
            container.init();
        })();
    </script>
</body>

</html>
