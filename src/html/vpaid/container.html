<html>
<head>
    <style>{COMPILED_CSS}</style>
</head>
<body>
    <div class="progress">
        <div class="circle-base"></div>
        <div class="progress-wrapper">
            <div class="circle-left"></div>
            <div class="circle-right"></div>
        </div>
    </div>
    <div class="video-player-slot">
        <video
            poster="data:image/svg+xml;base64,"
            playsinline>
        </video>
    </div>
    <script src="{{VPAID_SRC_URL}}"></script>
    <script>
        (function(global) {
            var NativeBridge = function() {
                var _this = this;

                this.eventHandlers = {};

                this.receiveEvent = function(args) {
                    var event = args.shift();
                    var parameters = args.shift();
                    _this.trigger(event, parameters);
                };

                this.addEventListener = function(event, listener) {
                    var listeners = _this.eventHandlers[event] || [];
                    listeners.push(listener);
                    _this.eventHandlers[event] = listeners;
                };

                this.sendEvent = function(event, parameters) {
                    window.webplayerbridge.sendEvent(JSON.stringify([event, parameters]));
                };

                this.trigger = function(event, parameters) {
                    if (event in _this.eventHandlers) {
                        var listeners = _this.eventHandlers[event];
                        for (var i = listeners.length - 1; i >= 0; i--) {
                            var listener = listeners[i];
                            listener.apply(global, parameters);
                        }
                    }
                };
            };

            global.nativebridge = new NativeBridge();
        })(window);
    </script>
    <script>
        (function() {
            var nativebridge = window.nativebridge;

            // List of all ad events
            var creativeEvents = [
                'loaded', 'skipped', 'started', 'stopped',
                'linearChange', 'expandedChange', 'remaningTimeChange',
                'volumeChange', 'impression', 'videoStart', 'videoFirstQuartile',
                'videoMidpoint', 'videoThirdQuartile', 'videoComplete',
                'clickThru', 'interaction', 'userAcceptInvitation',
                'userMinimize', 'userClose', 'paused', 'playing',
                'log', 'error'
            ];


            var Container = function() {
                this._iframe = document.querySelector('iframe');
                this._creative = null;
                this._slot = document.querySelector('.video-player-slot');
                this._videoSlot = this._slot.querySelector('video');
                this._progressElement = document.querySelector('.progress');
                this._leftCircleElement = document.querySelector('.circle-left');
                this._rightCircleElement = document.querySelector('.circle-right');
                this._wrapperElement = document.querySelector('.progress-wrapper');

                var _this = this;

                var eventHandlers = {
                    init: function() {
                        _this._initAd.apply(_this, arguments);
                    },
                    show: function() {
                        _this._showAd.apply(_this, arguments);
                    },
                    destroy: function() {
                        _this._stopAd.apply(_this, arguments);
                    },
                    pause: function() {
                        _this._pauseAd.apply(_this, arguments);
                    },
                    resume: function() {
                        _this._resumeAd.apply(_this, arguments);
                    }
                };

                for (var event in eventHandlers) {
                    window.nativebridge.addEventListener(event, eventHandlers[event]);
                }

                this._videoSlot.addEventListener('timeupdate', function(e) {
                    _this._sendProgressEvent();
                    _this._updateProgress();
                });

                this._updateProgress = function() {
                    var progress = _this._videoSlot.currentTime;
                    var duration = _this._videoSlot.duration;
                    var time = Math.floor(duration - progress);
                    var delta = progress / duration;

                    _this._progressElement.setAttribute('data-seconds', time);

                    var degrees = delta * 360;
                    _this._leftCircleElement.style.webkitTransform = 'rotate(' + degrees + 'deg)';

                    if (delta >= 0.5) {
                        _this._wrapperElement.style.webkitAnimationName = 'close-progress-wrapper';
                        _this._rightCircleElement.style.webkitAnimationName = 'right-spin';
                    }
                };

                this.init = function() {
                    var getVPAID = this._getVPAIDFunction();
                    if (getVPAID && typeof getVPAID === 'function') {
                        _this._creative = getVPAID();

                        _this._subscribeToAllEvents();

                        nativebridge.sendEvent('ready');
                    } else {
                        _this._triggerError('getVPAIDAd is not defined');
                    }
                };

                this.getHandshakeVersion = function() {
                    return _this._creative.handshakeVersion('2.0');
                };

                this.getAdDuration = function() {
                    if (_this._creative.getAdDuration) {
                        return _this._creative.getAdDuration();
                    } else {
                        return _this._creative.adDuration || -2;
                    }
                };

                this.getAdRemainingTime = function() {
                    if (_this._creative.getAdRemainingTime) {
                        return _this._creative.getAdRemainingTime();
                } else {
                        return _this._creative.adRemainingTime || -2;
                    }
                };

                this._triggerError = function(e) {
                    window.nativebridge.sendEvent('VPAID', ['AdError', [e]])
                }

                this._subscribeToAllEvents = function() {
                    var len = creativeEvents.length;
                    for (var i = 0; i < creativeEvents.length; i++) {
                        var creativeEvent = creativeEvents[i];
                        var normalizedEventName = 'Ad' + creativeEvent.charAt(0).toUpperCase() + creativeEvent.substring(1);
                        _this._subscribeToEvent(normalizedEventName);
                    }
                };

                this._subscribeToEvent = function(eventName) {
                    _this._creative.subscribe(function() {
                        var args = [eventName].concat(Array.prototype.slice.call(arguments));
                        _this._handleEvent.apply(_this, args);
                    }, eventName, _this);
                }

                this._getVPAIDFunction = function() {
                    return window.getVPAIDAd;
                };

                this._handleEvent = function() {
                    var eventType = arguments[0];
                    var args = arguments.length > 1 ? Array.prototype.slice.call(arguments, 1) : [];
                    window.nativebridge.sendEvent('VPAID', [eventType, args]);
                };

                this._initAd = function(initOpts) {
                    this._version = this._creative.handshakeVersion('2.0');
                    this._creative.initAd(initOpts.width, initOpts.height, initOpts.viewMode, initOpts.bitrate, initOpts.creativeData, {
                        slot: _this._slot,
                        videoSlot: _this._videoSlot
                    });
                }

                this._showAd = function() {
                    this._creative.startAd();
                };

                this._stopAd = function() {
                    return this._creative.stopAd();
                };

                this._pauseAd = function() {
                    return this._creative.pauseAd();
                };

                this._resumeAd = function() {
                    return this._creative.resumeAd();
                };

                this._sendProgressEvent = function() {
                    window.nativebridge.sendEvent('progress', [_this._videoSlot.duration, _this._videoSlot.duration - _this._videoSlot.currentTime]);
                };
            };

            var container = window.container = new Container();
            container.init();
        })();
    </script>
</body>

</html>
