<script>
    (function() {

        var supportedMimeTypes = {
            android: ['video/3gpp', 'video/3gpp2', 'video/mp4', 'video/webm'],
            ios: ['video/3gpp', 'video/x-m4v', 'video/mp4', 'video/quicktime'],
        };
        var android = /(android)/i.test(navigator.userAgent);
        var mimeTypes = android ? supportedMimeTypes.android : supportedMimeTypes.ios;

        var sourceProperty = {
            get: function() {
                return this._src;
            },
            set: function(src) {
                this._src = src;
                this.sendVideoEvent('prepare', {
                    url: src
                });
            }
        };

        var currentTimeProperty = {
            get: function() {
                return this._currentTime;
            },
            set: function(currentTime) {
                throw new Error('set currentTime not supported')
            }
        };

        var styleProperty = {
            get: function() {
                return this._element.style;
            }
        };

        var durationProperty = {
            get: function() {
                return this._duration;
            },
            set: function(duration) {
                throw new Error('set duration not supported');
            }
        }

        _element = document.createElement('div');
        Object.defineProperty(_element, 'src', sourceProperty);
        Object.defineProperty(_element, 'currentTime', currentTimeProperty);
        Object.defineProperty(_element, 'duration', durationProperty);

        var originalSetProperty = _element.style.setProperty;
        _element.style.setProperty = function(name, value, priority) {
            return originalSetProperty.call(_element,style, [name, value, priority]);
        };

        window.addEventListener('message', function(e) {
            _element.onMessage(e);
        });

        _element.sendVideoEvent = function(event, data) {
            var eventData = {
                type: 'player',
                event: event
            };
            if (data) {
                eventData.data = data;
            }

            window.parent.postMessage(eventData, '*');
        };

        _element.onMessage = function(e) {
            if (e.data.type && e.data.type === 'player') {
                this.handleEvent(e.data.event, e.data.data);
            }
        };

        _element.handleEvent = function(event, data) {
            switch (event) {
                case 'prepared':
                    this.handleVideoPrepared(data);
                    break;
                case 'canplay':
                    this.dispatchEvent(new Event('canplay'));
                    break;
                case 'progress':
                    this.handleProgress(data);
                    break;
                case 'play':
                    this.dispatchEvent(new Event('play'));
                    break;
                case 'playing':
                    this.dispatchEvent(new Event('playing'));
                    break;
                case 'pause':
                    this.dispatchEvent(new Event('pause'));
                    break;
                case 'ended':
                    this.dispatchEvent(new Event('ended'));
                    break;
                case 'error':
                    var e = new ErrorEvent('error');
                    e.error = data;
                    this.dispatchEvent(e);
                    break;
            }
        };

        _element.handleVideoPrepared = function(data) {
            this._duration = data.duration;
            this.dispatchEvent(new Event('durationchange'));
        };

        _element.handleProgress = function(data) {
            var progress = data.progress;
            if (this._currentTime != progress) {
                this._currentTime = progress;
                this.dispatchEvent(new Event('timeupdate'));
                this._lastUpdate = Date.now();
                this._stalledSent = false;
            } else {
                if (Date.now() - this._lastUpdate > 5 * 5000) {
                    this.dispatchEvent(new Event('stalled'));
                }
            }
        };

        _element.play = function() {
            this.sendVideoEvent('play');
        };

        _element.load = function() {
        };

        _element.canPlayType = function(mimeType) {
            return mimeTypes.indexOf(mimeType) !== -1 ? 'probably' : 'maybe';
        };

        window.VideoPlayer = _element;
    })();
</script>
