<script>
    (function() {
        var sourceProperty = {
            get: function() {
                return this._src;
            },
            set: function(src) {
                this._src = src;
                this.sendVideoEvent('prepare', {
                    url: src
                });
            }
        };

        var currentTimeProperty = {
            get: function() {
                return this._currentTime;
            },
            set: function(currentTime) {
                throw new Error('set currentTime not supported')
            }
        };

        var VideoPlayerBridge = function() {
            this._src = null;
            this._duration = 0;
            this._listeners = {};
            Object.defineProperty(this, 'src', sourceProperty);
            Object.defineProperty(this, 'currentTime', currentTimeProperty);

            var self = this;
            window.addEventListener('message', function(e) {
                self.onMessage(e);
            });
        };

        VideoPlayerBridge.prototype.addEventListener = function(event, listener) {
            if (event in this._listeners) {
                this._listeners[event].push(listener);
            } else {
                this._listeners[event] = [listener];
            }
        };
        VideoPlayerBridge.prototype.removeEventListener = function(event, listener) {
            if (event in this._listeners) {
                var index = this._listeners[event].indexOf(listener);
                if (index !== -1) {
                    this._listeners[event].splice(index, 1);
                }
            }
        };

        VideoPlayerBridge.prototype.sendVideoEvent = function(event, data) {
            var eventData = {
                type: 'player',
                event: event
            };
            if (data) {
                eventData.data = data;
            }

            window.parent.postMessage(eventData, '*');
        };

        VideoPlayerBridge.prototype.onMessage = function(e) {
            if (e.data.type && e.data.type === 'player') {
                this.handleEvent(e.data.event, e.data.data);
            }
        };

        VideoPlayerBridge.prototype.handleEvent = function(event, data) {
            switch (event) {
                case 'prepared':
                    this.handleVideoPrepared(data);
                    break;
                case 'canplay':
                    this.dispatchEvent('canplay');
                    break;
                case 'progress':
                    this.handleProgress(data);
                    break;
                case 'play':
                    this.dispatchEvent('play');
                    break;
                case 'playing':
                    this.dispatchEvent('playing');
                    break;
                case 'pause':
                    this.dispatchEvent('pause');
                    break;
                case 'ended':
                    this.dispatchEvent('ended');
                    break;
            }
        };

        VideoPlayerBridge.prototype.handleVideoPrepared = function(data) {
            this._duration = data.duration;
            this.dispatchEvent('durationchange');
        };

        VideoPlayerBridge.prototype.dispatchEvent = function(event, data) {
            if (event in this._listeners) {
                var listeners = this._listeners[event],
                    len = listeners.length;
                for (var i = 0; i < len; i++) {
                    var listener = listeners[i];
                    listener(data);
                }
            }
        };

        VideoPlayerBridge.prototype.handleProgress = function(data) {
            var progress = data.progress;
            if (this._currentTime != progress) {
                this._currentTime = progress;
                this.dispatchEvent('timeupdate');
            } else {
                // TODO update stuck counter.
            }
        };

        VideoPlayerBridge.prototype.play = function() {
            this.sendVideoEvent('play');
        };

        window.VideoPlayer = new VideoPlayerBridge();
    })();
</script>
