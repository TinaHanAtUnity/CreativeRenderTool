<script>
    /**
     * The OMIDSessionClient has yet to be approved by IAB
     * Pending Use based on OMID for Web specification completion
     * This will not be used in the initial run of Open Measurement
     * Please only refer to omid3p or OmidVerification for js verification
     */
    (function() {
        var OmidSessionInterface = function() {

            var ErrorType = {
                GENERIC: 'generic',                     // An error unrelated to video playback.
                VIDEO:   'video'                        // An error related to video playback.
            }

            var AccessMode = {
                FULL:    'full',                        // Verification scripts have access to the entire JS object graph and DOM.
                LIMITED: 'limited'                      // Verification scripts are limited to a sandboxed iframe.
            };

            this.Environment = {
                APP: 'app'
            };
        
            this.AdSessionType = {
                HTML: 'html'
            };

            this.SupportedFeatures = {
                CONTAINER: 'clid',
                VIDEO:     'vlid'
            };

            var omidNativeInfo = {
                partnerName: undefined,
                partnerVersion: undefined
            };

            var omidJSInfo = {
                omidImplementer: 'Unity',
                serviceVersion: this.getUnitySDKVersion(),
                sessionClientVersion: undefined,
                partnerName: undefined,
                partnerVersion: undefined,
            }

            var Context = {
                apiVersion: this.getOMIDAPIVersion(),
                environment: undefined,
                accessMode: undefined,
                adSessionType: undefined,
                supports: undefined,
                omidNativeInfo: undefined,
                omidJsInfo: undefined,
                app: undefined,
                customReferenceIdentifier: undefined
            }

            var App = {
                omidImplementer: 'Unity',
                libraryVersion: '1.0',                  // First version of unity's implementation of OMID for Web
                appId: 'com.unity.ads',                 // The host app's identifier - unity sdk name
                adId: undefined,                        // The iOS or Android advertising identifier - set by unity?
            }

            var sessionCallback = {};
            var verificationParameters = '{}';          // empty until specified by resource
            var sdkVersion;
            var sessionId;
            var videoElement;
            var sentQuartiles = {};

            /*
            * Based on https://github.com/InteractiveAdvertisingBureau/Open-Measurement-JSClients/blob/master/version.txt
            */
            this.getOMIDAPIVersion = function() {
                return '1.2.10';
            }

            this.setClientInfo = function(sessionClientVersion, partnerName, partnerVersion) {
                omidNativeInfo.partnerName = partnerName;
                omidNativeInfo.partnerVersion = partnerVersion;

                omidJSInfo.sessionClientVersion = sessionClientVersion;
                omidJSInfo.partnerName = partnerName;
                omidJSInfo.partnerVersion = partnerVersion;
            };

            this.registerSessionObserver = function(sessionEventsCallback) {
                Context.apiVersion = this.getOMIDAPIVersion();
                Context.environment = Environment.APP;
                Context.accessMode = AccessMode.LIMITED;
                Context.adSessionType = AdSessionType.HTML;
                Context.supports = SupportedFeatures.VIDEO;
                Context.omidNativeInfo = omidNativeInfo;
                Context.omidJsInfo = omidJSInfo;
                Context.app = App;
                Context.customReferenceIdentifier = undefined;

                sessionCallback = sessionEventsCallback;
            };

            var AdEventType = {
                SESSION_START:  'sessionStart',
                SESSION_FINISH: 'sessionFinish',
                SESSION_ERROR:  'sessionError'
            };

            this.reportError = function(errorType, message) {
                var sessionErrorEventData = {
                    errorType: errorType,
                    message: message
                }

                var eventData = {
                    adSessionId: this.getSessionId(),
                    timestamp: + new Date(),
                    type: AdEventType.ERROR_TYPE,
                    data: sessionErrorEventData
                }

                sessionCallback.call(eventData);
                this.postMessage('reportError', eventData);
            };

            this.startAdSession = function() {
                var sessionStartEventData = {
                    context: this.Context,
                    verificationParameters: undefined
                }
                var eventData = {
                    adSessionId: this.getSessionId(),
                    timestamp: + new Date(),
                    type: AdEventType.SESSION_START,
                    data: sessionStartEventData
                }
                sessionCallback.call(eventData);
                this.postMessage('startAdSession', eventData);
            };
            
            this.finishAdSession = function() {
                var eventData = {
                    adSessionId: this.getSessionId(),
                    timestamp: + new Date(),
                    type: AdEventType.SESSION_FINISH,
                    data: {}
                }

                sessionCallback.call(eventData);
                this.postMessage('finishAdSession', eventData);
                
                sessionCallback = {};
            };

            this.injectVerificationScriptResources = function(verificationScriptResources) {
                this.verificationParameters = verificationScriptResources.verificationParameters;
                this.postMessage('verificationResources', verificationScriptResources);
            };

            this.setVideoElement = function(el) {
                videoElement = el;
            };

            /**
             * Events will be registered to the following objects and the creative session interface will call via
             */ 
            this.adEvents = {}
            this.mediaEvents = {}

            this.registerAdEvents = function() {
                adEvents['impressionOccured'] = impressionOccured;
            };

            this.registerMediaEvents = function() {
                mediaEvents['loaded'] = loaded;
                mediaEvents['start'] = start;
                mediaEvents['firstQuartile'] = firstQuartile;
                mediaEvents['midpoint'] = midpoint;
                mediaEvents['thirdQuartile'] = thirdQuartile;
                mediaEvents['complete'] = complete;
                mediaEvents['pause'] = pause;
                mediaEvents['resume'] = resume;
                mediaEvents['bufferStart'] = bufferStart;
                mediaEvents['bufferFinish'] = bufferFinish;
                mediaEvents['skipped'] = skipped;
                mediaEvents['volumeChange'] = volumeChange;
                mediaEvents['playerStateChange'] = playerStateChange;
                mediaEvents['adUserInteraction'] = adUserInteraction;
            };

            var impressionOccured = function(impressionEventData) {
                this.postMessage('impressionOccured', impressionEventData);
            }

            var loaded = function(vastProperties) {
                this.postMessage('loaded', vastProperties);
            }
            var start = function(duration, videoPlayerVolume) {
                this.postMessage('start', {
                    duration: duration,
                    videoPlayerVolume: videoPlayerVolume
                });
            }
            var firstQuartile = function() {
                this.postMessage('firstQuartile');
            }
            var midpoint = function() {
                this.postMessage('midpoint');
            }
            var thirdQuartile = function() {
                this.postMessage('thirdQuartile');
            }
            var complete = function() {
                this.postMessage('complete');
            }
            var pause = function() {
                this.postMessage('pause');
            }
            var resume = function() {
                this.postMessage('resume');
            }
            var bufferStart = function() {
                this.postMessage('bufferStart');
            }
            var bufferFinish = function() {
                this.postMessage('bufferFinish');
            }
            var skipped = function() {
                this.postMessage('skipped');
            }
            var volumeChange = function(videoPlayerVolume) {
                this.postMessage('volumeChange', {
                    videoPlayerVolume: videoPlayerVolume
                });
            }
            var playerStateChange = function(playerState) {
                this.postMessage('playerStateChange', {
                    playerState: playerState
                });
            }
            var adUserInteraction = function(interactionType) {
                this.postMessage('adUserInteraction', {
                    interactionType: interactionType
                });
            }

            /** 
             * setSlotElement: 
             * Sets the slot element for a display creative for measurement. Currently dont support display
             * @param slotElement
             */
            this.setSlotElement = function(slotElement) {};

            /**
            * setElementBounds:
            * Only relevant to display ad slot elements. Called at beginning of playback and sessionfinish
            * @param (omidSessionInterface.Rectangle) elementBounds
            */
            this.setElementBounds = function(elementBounds) {};

            /**
             * Sets the creative type for the active ad session, or the next one if there is no
             * active ad session.
             * @param {omidSessionInterface.CreativeType} creativeType
             */
            this.setCreativeType = function(creativeType) {};

            /**
             * Sets the impression type for the active ad session, or the next one if there is no active ad session.
             * @param {omidSessionInterface.ImpressionType} impressionType
             */
            this.setImpressionType = function(impressionType) {};

            this.getSessionId = function() {
                return sessionId;
            }

            this.getUnitySDKVersion = function() {
                return sdkVersion;
            }

            this.postMessage = function(event, data) {
                window.parent.postMessage({
                    type: 'omid',
                    event: event,
                    data: data
                }, '*');
            };

            window.addEventListener('message', function(event) {
                switch(event.data.type) {
                    case 'sdkVersion':
                        sdkVersion = event.data.value;
                    case 'sessionId':
                        sessionId = event.data.value;
                }
            });

        }

        Object.defineProperty(window, 'omidSessionInterface', {
            value: new OmidSessionInterface(),
            writable: false
        });
        Object.freeze(window.omidSessionInterface);
    })();
</script>
