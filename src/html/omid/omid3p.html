<html>
    <head>
        <script>
            (function() {
                var OmidVerification = function() {
        
                    /**
                     * Enum for ad event types.
                     * @enum {string}
                     */
                    var videoListeners = {
                        /* 
                        * Common Video Event Types
                        */
                        loaded: [],
                        start: [],
                        firstQuartile: [],
                        midpoint: [],
                        thirdQuartile: [],
                        complete: [],
                        pause: [],
                        resume: [],
                        bufferStart: [],
                        bufferFinish: [],
                        skipped: [],
                        volumeChange: [],
                        playerStateChange: [],
                        adUserInteraction: [],
                        video: [],
        
                        /* 
                        * Common Ad Event Types
                        */
                        geometryChange: [],
                        impression: []
                    };
        
                    /**
                     * Calls the corresponding listener events function
                     * @param {string} event to send to the server
                     * @param {Object} parameters of the event
                     */
                    var trigger = function(event, parameters) {
                        if(!parameters) {
                            parameters = [];
                        }
                        if(event in videoListeners) {
                            videoListeners[event].forEach(function(listener) {
                                listener(parameters);
                            });

                            if (event !== 'geometryChange' && event !== 'impression' && event !== 'video') {
                                videoListeners['video'].forEach(function(listener) {
                                    listener(parameters);
                                });
                            }
                        }
                    };
        
                    var DEFAULT_VENDOR_KEY = '';
                    var sessionObserversMap = {DEFAULT_VENDOR_KEY: []};
                    var sessionStartData = {};
                    var sessionStartCalled = false;
                    var startCalledFromCreative = false;
                    var registerCalled = false;
        
                    /**
                     * Flattens and runs SessionObserver for each unique key/verification client with the specified eventdata
                     * @param {Object} eventData structured data to indicate type for observer to fire
                     */
                    var triggerSessionObserver = function(eventData) {
                        const observerList = Object.keys(sessionObserversMap).map(function(vendorKey) {
                            return sessionObserversMap[vendorKey];
                        });
                        const sessionObservers = [].concat.apply([], observerList);
                        sessionObservers.forEach(function(sessionObserver) {
                            sessionObserver(eventData);
                        });
                    }
        
                    /**
                     * Callback to communicate back to TS layer of changed state
                     * @param {string} event to send to the server
                     * @param {Object} data of the event
                     */
                    var postMessageCallback = function(event, data) {
                        window.parent.postMessage({
                            type: 'omid',
                            event: event,
                            data: data
                        }, '*');
                    };

                    /**
                     * Calls SessionListener for unique verificationScript observer of specified vendorkey
                     * @param {function} observer
                     * @param {string} vendorkey
                     */
                    var sendSessionStart = function(observer, vendorkey) {
                        observer(sessionStartData[vendorkey]);
                    }

                    /**
                     * Calls SessionListener for specified vendorkey
                     * @param {string} key
                     */
                    var sendSessionStartIfReady = function(key) {
                        if (key === DEFAULT_VENDOR_KEY) {
                            sessionObserversMap[key].forEach((sessionObserver) => {
                                sendSessionStart(sessionObserver, key);
                            });
                        } else {
                            sendSessionStart(sessionObserversMap[key], key);
                        }
                        postMessageCallback('onEventProcessed', {
                            eventType: 'sessionStart'
                        });
                        sessionStartCalled = true;
                    }
        
                    /**
                     * Strips 'omid' from string to be passed to vendor
                     * @param {string} event to send to the vendor
                     */
                    var stripEventString = function(eventType) {
                        return eventType.slice(4).charAt(0).toLowerCase() + eventType.slice(5);
                    }
                
                    var eventHandlers = {};
                    eventHandlers['omidImpression'] = (e) => trigger('impression', e);
                    eventHandlers['omidGeometryChange'] = (e) => trigger('geometryChange', e);
                    eventHandlers['omidLoaded'] = (e) => trigger('loaded', e);
                    eventHandlers['omidStart'] = (e) => trigger('start', e);
                    eventHandlers['omidFirstQuartile'] = (e) => trigger('firstQuartile', e);
                    eventHandlers['omidMidpoint'] = (e) => trigger('midpoint', e);
                    eventHandlers['omidThirdQuartile'] = (e) => trigger('thirdQuartile', e);
                    eventHandlers['omidComplete'] = (e) => trigger('complete', e);
                    eventHandlers['omidPause'] = (e) => trigger('pause', e);
                    eventHandlers['omidResume'] = (e) => trigger('resume', e);
                    eventHandlers['omidBufferStart'] = (e) => trigger('bufferStart', e);
                    eventHandlers['omidBufferFinish'] = (e) => trigger('bufferFinish', e);
                    eventHandlers['omidSkipped'] = (e) => trigger('skipped', e);
                    eventHandlers['omidVolumeChange'] = (e) => trigger('volumeChange', e);
                    eventHandlers['omidPlayerStateChange'] = (e) => trigger('playerStateChange', e);
                    eventHandlers['omidAdUserInteraction'] = (e) => trigger('adUserInteraction', e);
        
                    /**
                     * LifeCycle Event Listener
                     */
                    window.addEventListener('message', function(event) {
                        /*
                        * AD AND VIDEO EVENTS:
                        */
                        payload = event.data.payload;
                        const eventData = {
                                adSessionId: event.data.adSessionId,
                                timestamp: Date.now(),
                                type: stripEventString(event.data.type),
                                data: payload
                        }
                        if (event.data.type in eventHandlers) {
                            var handler = eventHandlers[event.data.type];
                            handler(eventData);
                        }
        
                        /* 
                        * SESSION EVENTS:
                        */
                        switch(event.data.type) {
                            case 'sessionStart':
                                startCalledFromCreative = true;
                                const data = event.data.data;

                                // if vendor key matches - start the session
                                if (sessionObserversMap[data.vendorkey] && !sessionStartCalled) {
                                    sessionStartData[data.vendorkey] = event.data;
                                    sendSessionStartIfReady(data.vendorkey);
                                } else {
                                    // just start the session with default -> vendor key does not matter here
                                    if (!data.verificationParameters && registerCalled) {
                                        sessionStartData[DEFAULT_VENDOR_KEY] = event.data;
                                        sendSessionStartIfReady(DEFAULT_VENDOR_KEY);
                                    } else {
                                        // if registration has not happened, store the data
                                        sessionStartData[data.vendorkey] = event.data;
                                    }
                                }
                                break;
                            case 'sessionFinish':
                                triggerSessionObserver(event.data);
                                for (var listener in videoListeners) { 
                                    delete videoListeners[listener]; 
                                }
        
                                postMessageCallback('onEventProcessed', {
                                    eventType: 'sessionFinish'
                                });
                                break;
                            case 'sessionError': 
                                triggerSessionObserver(event.data);
                                break;
                            default:
                                break;
                        }
                    });
        
                    /*
                    * Tells verification script omid3p is supported 
                    */
                    this.isSupported = function() {
                        return true;
                    }
        
                    this.postback = function(event, data) {
                        window.parent.postMessage({
                            type: 'omid',
                            event: event,
                            data: data
                        }, '*');
                    };
        
                    /*
                    * This method registers events and signals that the verification script has loaded and is ready to receive events
                    * Should be called upon initialization.
                    */
                    this.registerSessionObserver = function(functionToExecute, vendorKey) {
                        if (vendorKey) {
                            sessionObserversMap[vendorKey] = functionToExecute;
                            // if we've stored data for the vendor, start the session
                            if (!sessionStartCalled && sessionStartData[vendorKey]) {
                                sendSessionStartIfReady(vendorKey);
                            } 
                            // if we've already called start from the creative and have not stored vendor data, start the session with default key
                            if (startCalledFromCreative && !sessionStartData[vendorKey]) {
                                if (!sessionStartCalled && sessionStartData[DEFAULT_VENDOR_KEY]) {
                                    sendSessionStartIfReady(DEFAULT_VENDOR_KEY);
                                }
                            }
                        } else {
                            sessionObserversMap[DEFAULT_VENDOR_KEY].push(functionToExecute);
                            // if we've stored data for default vendor, start the session
                            if (!sessionStartCalled && sessionStartData[DEFAULT_VENDOR_KEY]) {
                                sendSessionStartIfReady(DEFAULT_VENDOR_KEY);
                            }
                        }

                        registerCalled = true;
                    }

                    this.addEventListener = function(type, listener) {
                        if(type in videoListeners && videoListeners[type] !== listener) {
                            videoListeners[type].push(listener);
                        }
                    }
        
                    this.sendUrl = function(resourceUrl, successCallback, failureCallback) {}
                    this.setTimeout = function() {}
                    this.setClearTimeout = function() {}
                    this.setInterval = function() {}
                    this.clearInterval = function() {}
                }
        
                /**
                 * Generic Vast verification scripts attach to this:
                 */
                // window.omid3p = new OmidVerification();
                // Object.freeze(window.omid3p);
        
                /**
                 * Used for IAB test:
                 * window.OmidVerificationClient = {'omid3p': OmidVerification};
                 * Object.freeze(window.OmidVerificationClient);
                 */
                window.OmidVerificationClient = {'omid3p': OmidVerification};
            })();
        </script>
    </head>
</html>
