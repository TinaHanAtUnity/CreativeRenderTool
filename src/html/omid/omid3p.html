<html>
    <head>
        <script>
            (function() {
                var OmidVerification = function() {

                    const ON_EVENT_PROCESSED = 'onEventProcessed',
                    SESSION_FINISH = 'sessionFinish',
                    SESSION_START = 'sessionStart',
                    SESSION_ERROR = 'sessionError',
                    SESSION_REGISTERED = 'sessionRegistered';
                    let videoEventRegistered = false;
        
                    /**
                     * Enum for ad event types.
                     * @enum {string}
                     */
                    const videoListeners = {
                        /* 
                        * Common Video Event Types
                        */
                        loaded: [],
                        start: [],
                        firstQuartile: [],
                        midpoint: [],
                        thirdQuartile: [],
                        complete: [],
                        pause: [],
                        resume: [],
                        bufferStart: [],
                        bufferFinish: [],
                        skipped: [],
                        volumeChange: [],
                        playerStateChange: [],
                        adUserInteraction: [],
                        video: [],
        
                        /* 
                        * Common Ad Event Types
                        */
                        geometryChange: [],
                        impression: []
                    };

                    let handleEventCall = function(event, parameters) {
                        
                        /**
                         * Calls any events passed individually
                         */
                        videoListeners[event].forEach(function(listener) {
                            listener(parameters);
                        });

                        /**
                         * Calls video events of aggregate common video event types
                         */
                        if (event !== 'geometryChange' && event !== 'impression' && event !== 'video') {
                            videoListeners['video'].forEach(function(listener) {
                                listener(parameters);
                            });
                        }
                    }

                    /**
                     * Calls the corresponding listener events function for Video/Ad events
                     * @param {string} event to send to the server
                     * @param {Object} parameters of the event
                     */
                    let trigger = function(event, parameters) {
                        if(!parameters) {
                            parameters = [];
                        }

                        if (event in videoListeners) {
                            handleEventCall(event, parameters);
                        }
                    };
        
                    let DEFAULT_VENDOR_KEY = '{{ DEFAULT_KEY_ }}';
                    let sessionObserversMap = {};
                    let sessionStartData = {};
                    let sessionStartCalled = false;
                    var scriptVendor = '';

                    /**
                     * Flattens and runs SessionObserver for each unique key/verification client with the specified eventdata
                     * @param {Object} eventData structured data to indicate type for observer to fire
                     */
                    let triggerSessionObserver = function(eventData) {
                        const observerList = Object.keys(sessionObserversMap).map(function(vendorKey) {
                            return sessionObserversMap[vendorKey];
                        });
                        const sessionObservers = [].concat.apply([], observerList);
                        sessionObservers.forEach(function(sessionObserver) {
                            sessionObserver(eventData);
                        });
                    }
        
                    /**
                     * Callback to communicate back to TS layer of changed state
                     * @param {string} event to send to the server
                     * @param {Object} data of the event
                     */
                    let postMessageCallback = function(event, data) {
                        window.parent.postMessage({
                            type: 'omid',
                            event: event,
                            data: data
                        }, '*');
                    };

                    /**
                     * Calls SessionListener for unique verificationScript observer of specified vendorkey
                     * @param {function} observer
                     * @param {string} vendorkey
                     */
                    let sendSessionStart = function(observer, vendorkey) {
                        observer(sessionStartData[vendorkey]);
                        postMessageCallback(ON_EVENT_PROCESSED, {
                            eventType: SESSION_START,
                            vendorKey: vendorkey
                        });
                    }

                    /**
                     * Calls SessionListener for specified vendorkey
                     * @param {string} key
                     */
                    let sendSessionStartForKey = function(key) {
                        sessionObserversMap[key].forEach((sessionObserver) => {
                            sendSessionStart(sessionObserver, key);
                        });
                    }

                    let handleSessionStart = function(event) {
                        let data = event.data.data;
                        // If passed vendor matches the registered vendor
                        if (sessionObserversMap[data.vendorkey]) {
                            sessionStartData[data.vendorkey] = event.data;
                            if (!sessionStartCalled) {
                                sendSessionStartForKey(data.vendorkey);
                                sessionStartCalled = true;
                            }
                        } else {
                            // It is possible session start was called before a vendor registers so we must always store the data
                            sessionStartData[data.vendorkey] = event.data;

                            if (!data.verificationParameters) {
                                // If we've already stored data for a default key, we can send SessionStart since the params do not matter
                                if (sessionStartData[DEFAULT_VENDOR_KEY] && !sessionStartCalled) {
                                    sendSessionStartForKey(DEFAULT_VENDOR_KEY);
                                    sessionStartCalled = true;
                                } else {
                                    // Logs even if registration will happen later
                                    postMessageCallback(ON_EVENT_PROCESSED, {
                                        eventType: 'vendorkeyMismatch'
                                    });
                                }
                            } else {
                                // Logs even if registration will happen later
                                postMessageCallback(ON_EVENT_PROCESSED, {
                                    eventType: 'vendorkeyMismatch'
                                });
                            }
                        }
                    }
        
                    /**
                     * Strips 'omid' from string to be passed to vendor
                     * @param {string} event to send to the vendor
                     */
                    let stripEventString = function(eventType) {
                        return eventType.slice(4).charAt(0).toLowerCase() + eventType.slice(5);
                    }
                
                    let eventHandlers = {};
                    eventHandlers['omidImpression'] = (e) => trigger('impression', e);
                    eventHandlers['omidGeometryChange'] = (e) => trigger('geometryChange', e);
                    eventHandlers['omidLoaded'] = (e) => trigger('loaded', e);
                    eventHandlers['omidStart'] = (e) => trigger('start', e);
                    eventHandlers['omidFirstQuartile'] = (e) => trigger('firstQuartile', e);
                    eventHandlers['omidMidpoint'] = (e) => trigger('midpoint', e);
                    eventHandlers['omidThirdQuartile'] = (e) => trigger('thirdQuartile', e);
                    eventHandlers['omidComplete'] = (e) => trigger('complete', e);
                    eventHandlers['omidPause'] = (e) => trigger('pause', e);
                    eventHandlers['omidResume'] = (e) => trigger('resume', e);
                    eventHandlers['omidBufferStart'] = (e) => trigger('bufferStart', e);
                    eventHandlers['omidBufferFinish'] = (e) => trigger('bufferFinish', e);
                    eventHandlers['omidSkipped'] = (e) => trigger('skipped', e);
                    eventHandlers['omidVolumeChange'] = (e) => trigger('volumeChange', e);
                    eventHandlers['omidPlayerStateChange'] = (e) => trigger('playerStateChange', e);
                    eventHandlers['omidAdUserInteraction'] = (e) => trigger('adUserInteraction', e);
        
                    /**
                     * LifeCycle Event Listener
                     */
                    window.addEventListener('message', function(event) {
                        /*
                        * AD AND VIDEO EVENTS:
                        */
                        if (event.data.type in eventHandlers) {
                            payload = event.data.payload;
                            const eventData = {
                                    adSessionId: event.data.adSessionId,
                                    timestamp: event.data.timestamp,
                                    type: stripEventString(event.data.type),
                                    data: payload
                            }
                            var handler = eventHandlers[event.data.type];
                            handler(eventData);
                        }
        
                        /* 
                        * SESSION EVENTS:
                        */
                        switch(event.data.type) {
                            case SESSION_START:
                                handleSessionStart(event);
                                break;
                            case SESSION_FINISH:
                                triggerSessionObserver(event.data);
                                for (var listener in videoListeners) { 
                                    delete videoListeners[listener]; 
                                }
                                postMessageCallback(ON_EVENT_PROCESSED, {
                                    eventType: SESSION_FINISH,
                                    vendorKey: scriptVendor
                                });
                                break;
                            case SESSION_ERROR:
                                triggerSessionObserver(event.data);
                                break;
                            default:
                                break;
                        }
                    });
        
                    /*
                    * Tells verification script omid3p is supported 
                    */
                    this.isSupported = function() {
                        return true;
                    }
        
                    this.postback = function(event, data) {
                        window.parent.postMessage({
                            type: 'omid',
                            event: event,
                            data: data
                        }, '*');
                    };

                   /**
                     * Registers session events for the given vendor key
                     * @param {function} functionToExecute sessionObserver for given vendor
                     * @param {function} vendorKey optional param to attribute given vendor key to sessionObserver
                     */
                    this.registerSessionObserver = function(functionToExecute, vendorKey) {
                        if (!vendorKey) {
                            vendorKey = DEFAULT_VENDOR_KEY;
                        }

                        if (!sessionObserversMap[vendorKey]) {
                            sessionObserversMap[vendorKey] = [];
                        }

                        sessionObserversMap[vendorKey].push(functionToExecute);

                        if (!sessionStartCalled) {
                            scriptVendor = vendorKey;

                            postMessageCallback(ON_EVENT_PROCESSED, {
                                eventType: SESSION_REGISTERED,
                                vendorKey: vendorKey
                            });
                        }
                    }

                    this.addEventListener = function(type, listener) {
                        if(type in videoListeners && videoListeners[type] !== listener) {
                            videoListeners[type].push(listener);
                        }

                        const adjustEventTypeString = (eventType) => {
                            return `omid${eventType.charAt(0).toUpperCase()+eventType.slice(1)}`;
                        };

                        postMessageCallback('onEventRegistered', {
                            eventName: adjustEventTypeString(type),
                            vendorKey: scriptVendor
                        });
                    }

                    this.sendUrl = function(resourceUrl, successCallback, failureCallback) {}
                    this.setTimeout = function() {}
                    this.setClearTimeout = function() {}
                    this.setInterval = function() {}
                    this.clearInterval = function() {}
                }
        
                /**
                 * Generic Vast verification scripts attach to this:
                 */
                window.omid3p = new OmidVerification();
                Object.freeze(window.omid3p);

                /**
                 * Used for IAB test:
                 * window.OmidVerificationClient = {'omid3p': OmidVerification};
                 * Object.freeze(window.OmidVerificationClient);
                 */
            })();
        </script>
    </head>
</html>
